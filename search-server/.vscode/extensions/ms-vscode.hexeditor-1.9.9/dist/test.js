var jr=Object.create;var Q=Object.defineProperty;var Nr=Object.getOwnPropertyDescriptor;var Gr=Object.getOwnPropertyNames;var Qr=Object.getPrototypeOf,$r=Object.prototype.hasOwnProperty;var wt=r=>Q(r,"__esModule",{value:!0});var m=(r,e)=>()=>(r&&(e=r(r=0)),e);var d=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Jr=(r,e)=>{for(var t in e)Q(r,t,{get:e[t],enumerable:!0})},xt=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Gr(e))!$r.call(r,i)&&(t||i!=="default")&&Q(r,i,{get:()=>e[i],enumerable:!(s=Nr(e,i))||s.enumerable});return r},U=(r,e)=>xt(wt(Q(r!=null?jr(Qr(r)):{},"default",!e&&r&&r.__esModule?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r),Vr=(r=>(e,t)=>r&&r.get(e)||(t=xt(wt({}),e,1),r&&r.set(e,t),t))(typeof WeakMap!="undefined"?new WeakMap:0);var be=d(ve=>{"use strict";Object.defineProperty(ve,"__esModule",{value:!0});var gt=class{constructor(e,t,s){this.bias=e,this.backoffA=t,this.backoffB=s}next(e){let t=this.backoffA.next(e),s=this.backoffB.next(e);return t&&s&&Et(this.bias,t,s)}};ve.CompositeBackoff=gt;var Et=(r,e,t)=>({get duration(){switch(r){case"a":return e.duration;case"b":return t.duration;case"max":return Math.max(t.duration,e.duration);case"min":return Math.min(t.duration,e.duration);default:throw new Error(`Unknown bias "${r}" given to CompositeBackoff`)}},next(s){let i=e.next(s),o=t.next(s);return i&&o&&Et(r,i,o)}})});var xe=d($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});var we=class{constructor(e,t){this.interval=e,this.limit=t}next(){return Rt(this.interval,this.limit)}};$.ConstantBackoff=we;$.NeverRetryBackoff=new we(0,0);var Rt=(r,e,t=0)=>({duration:r,next(){if(e===void 0)return this;if(!(t>=e-1))return Rt(r,e,t+1)}})});var Re=d(Ee=>{"use strict";Object.defineProperty(Ee,"__esModule",{value:!0});var St=class{constructor(e){this.fn=e}next(e){return ge(this.fn).next(e)}};Ee.DelegateBackoff=St;var ge=(r,e,t=0)=>({duration:t,next(s){let i=r(s,e);if(i!==void 0)return typeof i=="number"?ge(r,e,i):ge(r,i.state,i.delay)}})});var Se=d(E=>{"use strict";Object.defineProperty(E,"__esModule",{value:!0});E.noJitterGenerator=(r=0,e)=>[Math.min(e.maxDelay,e.initialDelay*2**r),r+1];E.fullJitterGenerator=(r,e)=>{let[t,s]=E.noJitterGenerator(r,e);return[Math.floor(Math.random()*t),s]};E.halfJitterGenerator=(r,e)=>{let[t,s]=E.noJitterGenerator(r,e);return[Math.floor((t+Math.random()*t)/2),s]};var Yr=4,Zr=1/1.4;E.decorrelatedJitterGenerator=(r,e)=>{let[t,s]=r||[0,0],i=t+Math.random(),o=Math.pow(e.exponent,i)*Math.tanh(Math.sqrt(Yr*i)),n=Math.max(0,o-s);return[Math.min(n*Zr*e.initialDelay,e.maxDelay),[t+1,o]]}});var Ut=d(Ae=>{"use strict";Object.defineProperty(Ae,"__esModule",{value:!0});var Kr=Se(),At={generator:Kr.decorrelatedJitterGenerator,maxDelay:3e4,maxAttempts:1/0,exponent:2,initialDelay:128},kt=class{constructor(e){this.options=e?{...At,...e}:At}next(){return Dt(this.options).next(void 0)}};Ae.ExponentialBackoff=kt;var Dt=(r,e,t=0,s=-1)=>({duration:t,next(){if(s>=r.maxAttempts-1)return;let[i,o]=r.generator(e,r);return Dt(r,o,i,s+1)}})});var De=d(ke=>{"use strict";Object.defineProperty(ke,"__esModule",{value:!0});var _t=class{constructor(e){this.durations=e}next(){return Ft(this.durations,0)}};ke.IterableBackoff=_t;var Ft=(r,e)=>({duration:r[e],next:()=>e<r.length-1?Ft(r,e+1):void 0})});var Ue=d(J=>{"use strict";function C(r){for(var e in r)J.hasOwnProperty(e)||(J[e]=r[e])}Object.defineProperty(J,"__esModule",{value:!0});C(be());C(xe());C(Re());C(Ut());C(Se());C(De())});var V=d(_e=>{"use strict";Object.defineProperty(_e,"__esModule",{value:!0});var Ct=class extends Error{constructor(e="Operation cancelled"){super(e);this.message=e,this.isTaskCancelledError=!0}};_e.TaskCancelledError=Ct});var S=d(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0});var It=V();R.noopDisposable={dispose:()=>{}};var Xr;(function(r){r.once=(e,t)=>{let s=!1,i;return i=e(o=>{t(o),i?i.dispose():s=!0}),s?(i.dispose(),R.noopDisposable):i},r.toPromise=(e,t)=>t?t.isCancellationRequested?Promise.reject(new It.TaskCancelledError):new Promise((s,i)=>{let o=r.once(e,a=>{n.dispose(),s(a)}),n=r.once(t.onCancellationRequested,()=>{o.dispose(),i(new It.TaskCancelledError)})}):new Promise(s=>r.once(e,s))})(Xr=R.Event||(R.Event={}));var Fe=class{constructor(){this.addListener=e=>this.addListenerInner(e)}get size(){return this.listeners?typeof this.listeners=="function"?1:this.listeners.length:0}emit(e){if(this.listeners)if(typeof this.listeners=="function")this.listeners(e);else for(let t of this.listeners)t(e)}addListenerInner(e){return this.listeners?typeof this.listeners=="function"?this.listeners=[this.listeners,e]:this.listeners.push(e):this.listeners=e,{dispose:()=>this.removeListener(e)}}removeListener(e){if(!this.listeners)return;if(typeof this.listeners=="function"){this.listeners===e&&(this.listeners=void 0);return}let t=this.listeners.indexOf(e);t!==-1&&(this.listeners.length===2?this.listeners=t===0?this.listeners[1]:this.listeners[0]:this.listeners=this.listeners.slice(0,t).concat(this.listeners.slice(t+1)))}};R.EventEmitter=Fe;var Tt=class extends Fe{constructor(){super(...arguments);this.addListener=e=>{let t=this.addListenerInner(e);return this.lastValue&&e(this.lastValue.value),t}}get hasEmitted(){return!!this.lastValue}emit(e){this.lastValue={value:e},super.emit(e)}};R.MemorizingEventEmitter=Tt});var w=d(Y=>{"use strict";Object.defineProperty(Y,"__esModule",{value:!0});var B=S(),qt=class{constructor(e){this.onCancel=new B.MemorizingEventEmitter,this.token=new _(this.onCancel.addListener),e&&(this.parentListener=e.onCancellationRequested(()=>this.cancel()))}cancel(){this.parentListener&&(this.parentListener.dispose(),this.parentListener=void 0),this.onCancel.hasEmitted||this.onCancel.emit()}};Y.CancellationTokenSource=qt;var _=class{constructor(e){this.onCancellationRequested=e,this.isRequested=!1,B.Event.once(e,()=>this.isRequested=!0)}get isCancellationRequested(){return this.isRequested}cancellation(e){return B.Event.toPromise(this.onCancellationRequested,e)}};Y.CancellationToken=_;_.None=new _(()=>B.noopDisposable);_.Cancelled=new _(r=>(r(void 0),B.noopDisposable))});var I=d(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});var Pt=S();K.returnOrThrow=r=>{if("error"in r)throw r.error;return"success"in r?r.success:r.value};var es=()=>{if(typeof performance!="undefined"){let r=performance.now();return()=>performance.now()-r}else{let r=process.hrtime.bigint();return()=>Number(process.hrtime.bigint()-r)/1e6}},Z=class{constructor(e=()=>!1,t=()=>!1){this.errorFilter=e,this.resultFilter=t,this.successEmitter=new Pt.EventEmitter,this.failureEmitter=new Pt.EventEmitter,this.onSuccess=this.successEmitter.addListener,this.onFailure=this.failureEmitter.addListener}derive(){let e=new Z(this.errorFilter,this.resultFilter);return e.onSuccess(t=>this.successEmitter.emit(t)),e.onFailure(t=>this.failureEmitter.emit(t)),e}async invoke(e,...t){let s=this.successEmitter.size||this.failureEmitter.size?es():null;try{let i=await e(...t);return this.resultFilter(i)?(s&&this.failureEmitter.emit({duration:s(),handled:!0,reason:{value:i}}),{value:i}):(s&&this.successEmitter.emit({duration:s()}),{success:i})}catch(i){let o=this.errorFilter(i);if(s&&this.failureEmitter.emit({duration:s(),handled:o,reason:{error:i}}),!o)throw i;return{error:i}}}};K.ExecuteWrapper=Z});var Ie=d(Ce=>{"use strict";Object.defineProperty(Ce,"__esModule",{value:!0});var Ot=class extends Error{constructor(e="Execution prevented because the circuit breaker is open"){super(e);this.isBrokenCircuitError=!0}};Ce.BrokenCircuitError=Ot});var qe=d(Te=>{"use strict";Object.defineProperty(Te,"__esModule",{value:!0});var Mt=class extends Error{constructor(e,t){super(`Bulkhead capacity exceeded (0/${e} execution slots, 0/${t} available)`);this.isBulkheadRejectedError=!0}};Te.BulkheadRejectedError=Mt});var Oe=d(Pe=>{"use strict";Object.defineProperty(Pe,"__esModule",{value:!0});var ts=Ie(),Bt=class extends ts.BrokenCircuitError{constructor(){super("Execution prevented because the circuit breaker is open");this.isIsolatedCircuitError=!0}};Pe.IsolatedCircuitError=Bt});var ee=d(A=>{"use strict";function X(r){for(var e in r)A.hasOwnProperty(e)||(A[e]=r[e])}Object.defineProperty(A,"__esModule",{value:!0});X(Ie());X(qe());X(Oe());X(V());A.isBrokenCircuitError=r=>!!r&&r instanceof Error&&"isBrokenCircuitError"in r;A.isBulkheadRejectedError=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;A.isIsolatedCircuitError=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;A.isTaskCancelledError=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r});var re=d(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});var rs=w(),te=S(),Ht=I(),Lt=ee(),ss=Oe(),p;(function(r){r[r.Closed=0]="Closed",r[r.Open=1]="Open",r[r.HalfOpen=2]="HalfOpen",r[r.Isolated=3]="Isolated"})(p=H.CircuitState||(H.CircuitState={}));var zt=class{constructor(e,t){this.options=e,this.executor=t,this.breakEmitter=new te.EventEmitter,this.resetEmitter=new te.EventEmitter,this.halfOpenEmitter=new te.EventEmitter,this.stateChangeEmitter=new te.EventEmitter,this.innerState={value:p.Closed},this.onBreak=this.breakEmitter.addListener,this.onReset=this.resetEmitter.addListener,this.onHalfOpen=this.halfOpenEmitter.addListener,this.onStateChange=this.stateChangeEmitter.addListener,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}get state(){return this.innerState.value}get lastFailure(){return this.innerLastFailure}isolate(){this.innerState.value!==p.Isolated&&(this.innerState={value:p.Isolated,counters:0},this.breakEmitter.emit({isolated:!0}),this.stateChangeEmitter.emit(p.Isolated)),this.innerState.counters++;let e=!1;return{dispose:()=>{e||(e=!0,this.innerState.value===p.Isolated&&!--this.innerState.counters&&(this.innerState={value:p.Closed},this.resetEmitter.emit(),this.stateChangeEmitter.emit(p.Closed)))}}}async execute(e,t=rs.CancellationToken.None){let s=this.innerState;switch(s.value){case p.Closed:let i=await this.executor.invoke(e,{cancellationToken:t});return"success"in i?this.options.breaker.success(s.value):(this.innerLastFailure=i,this.options.breaker.failure(s.value)&&this.open(i)),Ht.returnOrThrow(i);case p.HalfOpen:if(await s.test.catch(()=>{}),this.state===p.Closed&&t.isCancellationRequested)throw new Lt.TaskCancelledError;return this.execute(e);case p.Open:if(Date.now()-s.openedAt<this.options.halfOpenAfter)throw new Lt.BrokenCircuitError;let o=this.halfOpen(e,t);return this.innerState={value:p.HalfOpen,test:o},this.stateChangeEmitter.emit(p.HalfOpen),o;case p.Isolated:throw new ss.IsolatedCircuitError;default:throw new Error(`Unexpected circuit state ${s}`)}}async halfOpen(e,t){this.halfOpenEmitter.emit();try{let s=await this.executor.invoke(e,{cancellationToken:t});return"success"in s?(this.options.breaker.success(p.HalfOpen),this.close()):(this.innerLastFailure=s,this.options.breaker.failure(p.HalfOpen),this.open(s)),Ht.returnOrThrow(s)}catch(s){throw this.close(),s}}open(e){this.state===p.Isolated||this.state===p.Open||(this.innerState={value:p.Open,openedAt:Date.now()},this.breakEmitter.emit(e),this.stateChangeEmitter.emit(p.Open))}close(){this.state===p.HalfOpen&&(this.innerState={value:p.Closed},this.resetEmitter.emit(),this.stateChangeEmitter.emit(p.Closed))}};H.CircuitBreakerPolicy=zt});var Nt=d(Me=>{"use strict";Object.defineProperty(Me,"__esModule",{value:!0});var Wt=re(),jt=class{constructor({threshold:e,duration:t,minimumRps:s}){if(this.windows=[],this.currentWindow=0,this.currentFailures=0,this.currentSuccesses=0,e<=0||e>=1)throw new RangeError(`SamplingBreaker threshold should be between (0, 1), got ${e}`);this.threshold=e;let i=Math.max(5,Math.ceil(t/1e3));for(let o=0;o<i;o++)this.windows.push({startedAt:0,failures:0,successes:0});this.windowSize=Math.round(t/i),this.duration=this.windowSize*i,s?this.minimumRpms=s/1e3:this.minimumRpms=5/(e*1e3)}success(e){e===Wt.CircuitState.HalfOpen&&this.resetWindows(),this.push(!0)}failure(e){if(this.push(!1),e!==Wt.CircuitState.Closed)return!0;let t=this.currentSuccesses+this.currentFailures;return t<this.duration*this.minimumRpms?!1:this.currentFailures>this.threshold*t}resetWindows(){this.currentFailures=0,this.currentSuccesses=0;for(let e of this.windows)e.failures=0,e.successes=0,e.startedAt=0}rotateWindow(e){let t=(this.currentWindow+1)%this.windows.length;this.currentFailures-=this.windows[t].failures,this.currentSuccesses-=this.windows[t].successes;let s=this.windows[t]={failures:0,successes:0,startedAt:e};return this.currentWindow=t,s}push(e){let t=Date.now(),s=this.windows[this.currentWindow];t-s.startedAt>=this.windowSize&&(s=this.rotateWindow(t)),e?(s.successes++,this.currentSuccesses++):(s.failures++,this.currentFailures++)}};Me.SamplingBreaker=jt});var Qt=d(Be=>{"use strict";Object.defineProperty(Be,"__esModule",{value:!0});var Gt=class{constructor(e){this.threshold=e,this.count=0}success(){this.count=0}failure(){return++this.count>=this.threshold}};Be.ConsecutiveBreaker=Gt});var Jt=d(se=>{"use strict";function $t(r){for(var e in r)se.hasOwnProperty(e)||(se[e]=r[e])}Object.defineProperty(se,"__esModule",{value:!0});$t(Nt());$t(Qt())});var Vt=d(He=>{"use strict";Object.defineProperty(He,"__esModule",{value:!0});He.defer=()=>{let r,e,t=new Promise((s,i)=>{r=s,e=i});return{resolve:r,reject:e,promise:t}}});var ze=d(Le=>{"use strict";Object.defineProperty(Le,"__esModule",{value:!0});var is=w(),ns=Vt(),os=S(),as=I(),cs=qe(),us=ee(),Yt=class{constructor(e,t){this.capacity=e,this.queueCapacity=t,this.active=0,this.queue=[],this.onRejectEmitter=new os.EventEmitter,this.executor=new as.ExecuteWrapper,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure,this.onReject=this.onRejectEmitter.addListener}get executionSlots(){return this.capacity-this.active}get queueSlots(){return this.queueCapacity-this.queue.length}async execute(e,t=is.CancellationToken.None){if(t.isCancellationRequested)throw new us.TaskCancelledError;if(this.active<this.capacity){this.active++;try{return await e({cancellationToken:t})}finally{this.active--,this.dequeue()}}if(this.queue.length<this.queueCapacity){let{resolve:s,reject:i,promise:o}=ns.defer();return this.queue.push({ct:t,fn:e,resolve:s,reject:i}),o}throw this.onRejectEmitter.emit(),new cs.BulkheadRejectedError(this.capacity,this.queueCapacity)}dequeue(){let e=this.queue.shift();!e||Promise.resolve().then(()=>this.execute(e.fn,e.ct)).then(e.resolve).catch(e.reject)}};Le.BulkheadPolicy=Yt});var je=d(We=>{"use strict";Object.defineProperty(We,"__esModule",{value:!0});var ls=w(),Zt=class{constructor(e,t){this.executor=e,this.value=t,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}async execute(e,t=ls.CancellationToken.None){let s=await this.executor.invoke(e,{cancellationToken:t});return"success"in s?s.success:this.value()}};We.FallbackPolicy=Zt});var Ge=d(Ne=>{"use strict";Object.defineProperty(Ne,"__esModule",{value:!0});var ds=w(),Kt=I(),Xt=class{constructor(){this.executor=new Kt.ExecuteWrapper,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}async execute(e,t=ds.CancellationToken.None){return Kt.returnOrThrow(await this.executor.invoke(e,{cancellationToken:t}))}};Ne.NoopPolicy=Xt});var Je=d($e=>{"use strict";Object.defineProperty($e,"__esModule",{value:!0});var fs=Ue(),ps=be(),Qe=xe(),hs=Re(),ms=De(),ys=w(),er=S(),vs=(r,e)=>new Promise(t=>{let s=setTimeout(t,r);e&&s.unref()}),ie=class{constructor(e,t){this.options=e,this.executor=t,this.onGiveUpEmitter=new er.EventEmitter,this.onRetryEmitter=new er.EventEmitter,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure,this.onRetry=this.onRetryEmitter.addListener,this.onGiveUp=this.onGiveUpEmitter.addListener}attempts(e){return this.composeBackoff("a",new Qe.ConstantBackoff(1,e))}delay(e){return this.composeBackoff("b",typeof e=="number"?new Qe.ConstantBackoff(e):new ms.IterableBackoff(e))}delegate(e){return this.composeBackoff("b",new hs.DelegateBackoff(e))}exponential(e={}){return this.composeBackoff("b",new fs.ExponentialBackoff(e))}backoff(e){return this.composeBackoff("b",e)}dangerouslyUnref(){return this.derivePolicy({...this.options,unref:!0})}async execute(e,t=ys.CancellationToken.None){let s=this.options.backoff||new Qe.ConstantBackoff(0,1),i;for(let o=0;;o++){let n=await this.executor.invoke(e,{attempt:o,cancellationToken:t});if("success"in n)return n.success;if(!t.isCancellationRequested){let a={attempt:o+1,cancellationToken:t,result:n};if(o===0?i=s.next(a):i&&(i=i.next(a)),i){let c=i.duration,u=vs(c,!!this.options.unref);this.onRetryEmitter.emit({...n,delay:c}),await u;continue}}if(this.onGiveUpEmitter.emit(n),"error"in n)throw n.error;return n.value}}composeBackoff(e,t){return this.options.backoff&&(t=new ps.CompositeBackoff(e,this.options.backoff,t)),this.derivePolicy({...this.options,backoff:t})}derivePolicy(e){let t=new ie(e,this.executor.derive());return t.onRetry(s=>this.onRetryEmitter.emit(s)),t}};$e.RetryPolicy=ie});var Ye=d(L=>{"use strict";Object.defineProperty(L,"__esModule",{value:!0});var tr=w(),bs=S(),Ve=I(),ws=V(),rr;(function(r){r.Cooperative="optimistic",r.Aggressive="aggressive"})(rr=L.TimeoutStrategy||(L.TimeoutStrategy={}));var ne=class{constructor(e,t,s=new Ve.ExecuteWrapper,i=!1){this.duration=e,this.strategy=t,this.executor=s,this.unref=i,this.timeoutEmitter=new bs.EventEmitter,this.onTimeout=this.timeoutEmitter.addListener,this.onFailure=this.executor.onFailure,this.onSuccess=this.executor.onSuccess}dangerouslyUnref(){return new ne(this.duration,this.strategy,this.executor,!0)}async execute(e,t=tr.CancellationToken.None){let s=new tr.CancellationTokenSource(t),i=setTimeout(()=>s.cancel(),this.duration);this.unref&&i.unref();let o={cancellation:s.token,cancellationToken:s.token},n=s.token.onCancellationRequested(()=>this.timeoutEmitter.emit());try{return this.strategy===rr.Cooperative?Ve.returnOrThrow(await this.executor.invoke(e,o,s.token)):await this.executor.invoke(async()=>Promise.race([Promise.resolve(e(o,s.token)),s.token.cancellation(s.token).then(()=>{throw new ws.TaskCancelledError(`Operation timed out after ${this.duration}ms`)})])).then(Ve.returnOrThrow)}finally{n.dispose(),s.cancel(),clearTimeout(i)}}};L.TimeoutPolicy=ne});var sr=d(Ke=>{"use strict";Object.defineProperty(Ke,"__esModule",{value:!0});var xs=ze(),gs=w(),Es=re(),Ze=I(),Rs=je(),Ss=Ge(),As=Je(),ks=Ye(),oe=(r,e)=>e?t=>t instanceof r&&e(t):t=>t instanceof r,Ds=()=>!0,z=()=>!1,v=class{constructor(e){this.options=e}static wrap(...e){return{onFailure:e[0].onFailure,onSuccess:e[0].onSuccess,execute(t,s){let i=(o,n)=>n===e.length?t(o):e[n].execute(a=>i({...o,...a},n+1),o.cancellationToken);return Promise.resolve(i({cancellationToken:s},0))}}}static bulkhead(e,t=0){return new xs.BulkheadPolicy(e,t)}static handleAll(){return new v({errorFilter:Ds,resultFilter:z})}static handleType(e,t){return new v({errorFilter:oe(e,t),resultFilter:z})}static handleWhen(e){return new v({errorFilter:e,resultFilter:z})}static handleResultType(e,t){return new v({errorFilter:z,resultFilter:oe(e,t)})}static handleWhenResult(e){return new v({errorFilter:z,resultFilter:e})}static timeout(e,t){return new ks.TimeoutPolicy(e,t)}static use(e){return(t,s,i)=>{let o=i.value;if(typeof o!="function")throw new Error(`Can only decorate functions with @cockatiel, got ${typeof o}`);i.value=function(...n){let a=n[n.length-1]instanceof gs.CancellationToken?n.pop():void 0;return e.execute(c=>o.apply(this,[...n,c]),a)}}}orType(e,t){let s=oe(e,t);return new v({...this.options,errorFilter:i=>this.options.errorFilter(i)||s(i)})}orWhen(e){return new v({...this.options,errorFilter:t=>this.options.errorFilter(t)||e(t)})}orWhenResult(e){return new v({...this.options,resultFilter:t=>this.options.resultFilter(t)||e(t)})}orResultType(e,t){let s=oe(e,t);return new v({...this.options,resultFilter:i=>this.options.resultFilter(i)||s(i)})}retry(){return new As.RetryPolicy({},new Ze.ExecuteWrapper(this.options.errorFilter,this.options.resultFilter))}circuitBreaker(e,t){return new Es.CircuitBreakerPolicy({breaker:t,halfOpenAfter:e},new Ze.ExecuteWrapper(this.options.errorFilter,this.options.resultFilter))}fallback(e){return new Rs.FallbackPolicy(new Ze.ExecuteWrapper(this.options.errorFilter,this.options.resultFilter),typeof e=="function"?e:()=>e)}};Ke.Policy=v;v.noop=new Ss.NoopPolicy});var Xe=d(T=>{"use strict";function b(r){for(var e in r)T.hasOwnProperty(e)||(T[e]=r[e])}Object.defineProperty(T,"__esModule",{value:!0});b(Ue());b(Jt());b(ze());b(w());b(re());var ir=S();T.Event=ir.Event;T.EventEmitter=ir.EventEmitter;b(ee());b(je());b(Ge());b(sr());b(Je());b(Ye())});var nr,or=m(()=>{nr=r=>(e,t)=>{let s,i=0,o=t.length-1;for(;i<=o;)s=Math.floor((i+o)/2),r(t[s])>=e?o=s-1:i=s+1;return i}});var ae,et,ar=m(()=>{ae=Symbol("unset"),et=r=>{let e=ae,t=()=>(e===ae&&(e=r()),e);return t.getValue=()=>e===ae?void 0:e,t.forget=()=>{e=ae},t}});async function*_s(r,e,t=0,s=1024){let i=new Uint8Array(s);for(let o=0;o<e.length;o++){let n=e[o];if(n.op===1)continue;if(n.op===2){let u=n.offset+n.value.length-t;if(u<=0)continue;let f=u<n.value.length?n.value.subarray(-u):n.value;f.length>0&&(yield f);continue}let a=n.roffset+(o+1<e.length?e[o+1].offset:1/0)-n.offset,c=n.roffset+Math.max(0,t-n.offset);for(;c<a;){let u=await r.read(c,i.subarray(0,Math.min(i.length,a-c)));if(u===0)break;yield i.subarray(0,u),c+=u}}}var cr,Us,k,Fs,q=m(()=>{cr=U(Xe());or();ar();Us=r=>r.op===0?{...r,op:1,previous:r.value}:r.op===1?{...r,op:0,value:r.previous}:{...r,value:r.previous,previous:r.value},k=class{constructor(e){this.saveGuard=cr.Policy.bulkhead(1,1/0);this._unsavedEditIndex=0;this.getSizeInner=et(()=>this.accessor.getSize());this.getEditTimeline=et(()=>Fs(this._edits));this._edits=e.edits?e.edits.saved.concat(e.edits.unsaved):[],this._unsavedEditIndex=e.edits?.saved.length??0,this.supportsLengthChanges=e.supportsLengthChanges,this.isFiniteSize=e.isFiniteSize,this.accessor=e.accessor}get uri(){return this.accessor.uri}get isReadonly(){return!!this.accessor.isReadonly}async size(){if(!this.isFiniteSize)return;let e=await this.getSizeInner();if(e===void 0)return;let{sizeDelta:t}=this.getEditTimeline();return e+t}get edits(){return this._edits}get unsavedEdits(){return this._edits.slice(this.unsavedEditIndex)}get unsavedEditIndex(){return this._unsavedEditIndex}get isSynced(){return this.unsavedEditIndex===this.edits.length}readInto(e,t){return this.accessor.read(e,t)}readWithEdits(e=0,t=128*1024){return _s(this.accessor,this.getEditTimeline().ranges,e,t)}save(){let e=this._edits.slice(this.unsavedEditIndex);return e.length===0?Promise.resolve():(this._unsavedEditIndex+=e.length,this.saveGuard.execute(async()=>{e.some(t=>t.op!==2||t.previous.length!==t.value.length)?await this.accessor.writeStream(this.readWithEdits()):await this.accessor.writeBulk(e.map(t=>({offset:t.offset,data:t.value}))),this.getSizeInner.forget()}))}revert(){this._unsavedEditIndex=0,this._edits=[],this.accessor.invalidate?.(),this.getEditTimeline.forget(),this.getSizeInner.forget()}makeEdits(e){let t=this._edits.length;return this._edits.push(...e),this.getEditTimeline.forget(),{undo:()=>(this.unsavedEditIndex<=t?this._edits.splice(t,e.length):this._edits.push(...e.map(Us)),this.getEditTimeline.forget(),this._edits),redo:()=>(this._edits.push(...e),this.getEditTimeline.forget(),this._edits)}}dispose(){this.accessor.dispose()}};Fs=r=>{let e=[{op:0,editIndex:-1,roffset:0,offset:0}],t=(n,a,c)=>a.op===0?{before:{op:0,editIndex:n,roffset:a.roffset,offset:a.offset},after:{op:0,editIndex:n,roffset:a.roffset+c,offset:a.offset+c}}:a.op===1?{before:{op:1,editIndex:n,offset:a.offset},after:{op:1,editIndex:n,offset:a.offset+c}}:{before:{op:2,editIndex:n,offset:a.offset,value:a.value.subarray(0,c)},after:{op:2,editIndex:n,offset:a.offset+c,value:a.value.subarray(c)}},s=nr(n=>n.offset),i=0,o=(n,a)=>{for(i+=a;n<e.length;n++)e[n].offset+=a};for(let n=0;n<r.length;n++){let a=r[n],c=s(a.offset,e);(c===e.length||e[c].offset>a.offset)&&c--;let u=e[c];if(a.op===0){let{before:f,after:l}=t(n,u,a.offset-u.offset);e.splice(c,1,f,{op:2,editIndex:n,offset:a.offset,value:a.value},l),o(c+2,a.value.length)}else if(a.op===1||a.op===2){let{before:f}=t(n,u,a.offset-u.offset),l=s(a.offset+a.previous.length,e);(l===e.length||e[l].offset>a.offset)&&l--;let{after:y}=t(n,e[l],a.offset+a.previous.length-e[l].offset);e.splice(c,l-c+1,f,a.op===2?{op:2,editIndex:n,offset:a.offset,value:a.value}:{op:1,editIndex:n,offset:a.offset},y),o(c+2,(a.op===2?a.value.length:0)-a.previous.length)}}return{ranges:e,sizeDelta:i}}});var Cs,Is,ce,Mi,Bi,Ts,W,ue,qs,le,ur,Ps,lr,Os,Ms,dr,fr,Bs,Hs,Ls,pr,zs,hr=m(()=>{Cs=typeof atob=="function",Is=typeof btoa=="function",ce=typeof Buffer=="function",Mi=typeof TextDecoder=="function"?new TextDecoder:void 0,Bi=typeof TextEncoder=="function"?new TextEncoder:void 0,Ts="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",W=Array.prototype.slice.call(Ts),ue=(r=>{let e={};return r.forEach((t,s)=>e[t]=s),e})(W),qs=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,le=String.fromCharCode.bind(String),ur=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):(r,e=t=>t)=>new Uint8Array(Array.prototype.slice.call(r,0).map(e)),Ps=r=>r.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),lr=r=>r.replace(/[^A-Za-z0-9\+\/]/g,""),Os=r=>{let e,t,s,i,o="",n=r.length%3;for(let a=0;a<r.length;){if((t=r.charCodeAt(a++))>255||(s=r.charCodeAt(a++))>255||(i=r.charCodeAt(a++))>255)throw new TypeError("invalid character found");e=t<<16|s<<8|i,o+=W[e>>18&63]+W[e>>12&63]+W[e>>6&63]+W[e&63]}return n?o.slice(0,n-3)+"===".substring(n):o},Ms=Is?r=>btoa(r):ce?r=>Buffer.from(r,"binary").toString("base64"):Os,dr=ce?r=>Buffer.from(r).toString("base64"):r=>{let e=4096,t=[];for(let s=0,i=r.length;s<i;s+=e)t.push(le.apply(null,r.subarray(s,s+e)));return Ms(t.join(""))},fr=(r,e=!1)=>e?Ps(dr(r)):dr(r),Bs=r=>{if(r=r.replace(/\s+/g,""),!qs.test(r))throw new TypeError("malformed base64.");r+="==".slice(2-(r.length&3));let e,t="",s,i;for(let o=0;o<r.length;)e=ue[r.charAt(o++)]<<18|ue[r.charAt(o++)]<<12|(s=ue[r.charAt(o++)])<<6|(i=ue[r.charAt(o++)]),t+=s===64?le(e>>16&255):i===64?le(e>>16&255,e>>8&255):le(e>>16&255,e>>8&255,e&255);return t},Hs=Cs?r=>atob(lr(r)):ce?r=>Buffer.from(r,"base64").toString("binary"):Bs,Ls=ce?r=>ur(Buffer.from(r,"base64")):r=>ur(Hs(r),e=>e.charCodeAt(0)),pr=r=>Ls(zs(r)),zs=r=>lr(r.replace(/[-_]/g,e=>e=="-"?"+":"/"))});var tt,js,Ns,P,rt=m(()=>{hr();tt=U(require("vscode")),js=new TextEncoder,Ns=new TextDecoder,P=class{constructor(e){this.uri=e}async write(e){let t=JSON.stringify(e,(s,i)=>i instanceof Uint8Array?{$u8:fr(i)}:i);await tt.workspace.fs.writeFile(this.uri,js.encode(t))}async read(){let e;try{e=Ns.decode(await tt.workspace.fs.readFile(this.uri))}catch{return[]}return JSON.parse(e,(t,s)=>s&&typeof s=="object"&&"$u8"in s?pr(s.$u8):s)}}});var mr,h,j,yr,Gs,vr,st,br,wr,nt,ot=m(()=>{mr=U(Xe()),h=U(require("vscode")),j=async(r,e)=>{if(r.scheme==="untitled")return new br(r,e??new Uint8Array);if(r.scheme==="vscode-debug-memory"){let{permissions:t=0}=await h.workspace.fs.stat(r);return new wr(r,!!(t&h.FilePermission.Readonly))}if(r.scheme==="file")try{let t=require("fs");if((await t.promises.stat(r.fsPath)).isFile())return new vr(r,t)}catch{}return new st(r)},yr=class{constructor(e,t){this.path=e;this._fs=t;this.borrowQueue=[];this.disposed=!1}borrow(e){return this.disposed?Promise.reject(new Error("FileHandle was disposed")):new Promise((t,s)=>{this.borrowQueue.push(async i=>{if(i instanceof Error)return s(i);try{t(await e(i))}catch(o){s(o)}}),this.borrowQueue.length===1&&this.process()})}dispose(){this.disposed=!0,this.handle=void 0,this.disposeTimeout&&clearTimeout(this.disposeTimeout),this.rejectAll(new Error("FileHandle was disposed"))}async close(){await this.handle?.close(),this.handle=void 0,this.disposeTimeout&&clearTimeout(this.disposeTimeout)}rejectAll(e){for(;this.borrowQueue.length;)this.borrowQueue.pop()(e)}async process(){for(this.disposeTimeout&&clearTimeout(this.disposeTimeout);this.borrowQueue.length;){if(!this.handle)try{this.handle=await this._fs.promises.open(this.path,this._fs.constants.O_RDWR|this._fs.constants.O_CREAT)}catch(e){return this.rejectAll(e)}await this.borrowQueue[0]?.(this.handle),this.borrowQueue.shift()}this.handle&&(this.disposeTimeout=setTimeout(()=>{this.handle?.close(),this.handle=void 0},1e3))}},Gs=mr.Policy.handleWhen(r=>r.code==="ENOENT").retry().attempts(10).delay(50),vr=class{constructor(e,t){this.fs=t;this.supportsIncremetalAccess=!0;this.uri=e.toString(),this.handle=new yr(e.fsPath,t)}watch(e,t){return nt(this.uri,e,t)}async getSize(){return this.handle.borrow(async e=>(await e.stat()).size)}async read(e,t){return this.handle.borrow(async s=>{let{bytesRead:i}=await s.read(t,0,t.byteLength,e);return i})}writeBulk(e){return this.handle.borrow(async t=>{for(let{data:s,offset:i}of e)t.write(s,0,s.byteLength,i)})}async writeStream(e,t){let s=`${this.handle.path}.tmp`,i=await this.fs.promises.open(s,this.fs.constants.O_WRONLY|this.fs.constants.O_CREAT|this.fs.constants.O_TRUNC);try{let o=0;for await(let n of e){if(t?.isCancellationRequested)return;await i.write(n,0,n.byteLength,o),o+=n.byteLength}}finally{await i.close()}return await this.handle.borrow(async()=>{await this.handle.close(),await Gs.execute(()=>this.fs.promises.rename(s,this.handle.path))}),this.handle.borrow(async o=>{if(t?.isCancellationRequested)return;let n=0;for await(let a of e){if(t?.isCancellationRequested)return;await o.write(a,0,a.byteLength,n),n+=a.byteLength}})}dispose(){this.handle.dispose()}},st=class{constructor(e){this.uri=e.toString(),this.fsPath=e.fsPath,this.isReadonly=h.workspace.fs.isWritableFileSystem(this.uri)===!1}watch(e,t){return nt(this.uri,e,t)}async getSize(){return(await h.workspace.fs.stat(h.Uri.parse(this.uri))).size}async read(e,t){let s=await this.getContents(),i=Math.min(t.length,s.length-e);return t.set(s.subarray(e,i+e)),i}async writeStream(e,t){let s=0,i=[];for await(let a of e){if(t?.isCancellationRequested)throw new h.CancellationError;i.push(a),s+=a.length}let o=new Uint8Array(s),n=0;for(let a of i)o.set(a,n),n+=a.length;await h.workspace.fs.writeFile(h.Uri.parse(this.uri),o)}async writeBulk(e){let t=await this.getContents();for(let{data:s,offset:i}of e)t.set(s,i);return h.workspace.fs.writeFile(h.Uri.parse(this.uri),t)}invalidate(){this.contents=void 0}dispose(){this.contents=void 0}getContents(){return this.contents??(this.contents=h.workspace.fs.readFile(h.Uri.parse(this.uri))),this.contents}},br=class extends st{constructor(e,t){super(e);this.contents=t}getSize(){return Promise.resolve(this.contents.byteLength)}},wr=class{constructor(e,t){this.isReadonly=t;this.supportsIncremetalAccess=!0;this.uri=e.toString()}watch(e,t){return nt(this.uri,e,t)}async getSize(){}async read(e,t){let s=await h.workspace.fs.readFile(this.referenceRange(e,e+t.length)),i=Math.min(t.length,s.length-e);return t.set(s.subarray(e,i+e)),i}async writeStream(){throw new Error("Not supported")}async writeBulk(e){await Promise.all(e.map(t=>h.workspace.fs.writeFile(this.referenceRange(t.offset,t.offset+t.data.length),t.data)))}referenceRange(e,t){return h.Uri.parse(this.uri).with({query:`?range=${e}:${t}`})}invalidate(){}dispose(){}},nt=(r,e,t)=>{let s=r.split("/"),i=s.pop(),o=new h.RelativePattern(h.Uri.parse(s.join("/")),i),n=h.workspace.createFileSystemWatcher(o);return n.onDidChange(e),n.onDidDelete(t),n}});var de,xr,gr,at,Er,ct,ut,fe,Rr,pe=m(()=>{de=require("crypto"),xr=require("os"),gr=require("path"),at=require("fs");ot();Er=U(require("vscode")),ct=[],ut=async r=>{let e=(0,gr.join)((0,xr.tmpdir)(),`vscode-hexeditor-test-${(0,de.randomBytes)(8).toString("hex")}.bin`);return ct.push(e),r&&await at.promises.writeFile(e,r),Er.Uri.file(e)},fe=async r=>j(await ut(r));afterEach(async()=>{await Promise.all(ct.map(at.promises.unlink)),ct=[]});Rr=r=>()=>{let e=(0,de.createHash)("md5").update(r).digest();return r=e,e.readUInt32BE()/4294967295}});var Qs={};var Sr,Ar=m(()=>{Sr=require("chai");q();rt();pe();describe("Backup",()=>{let r=[{op:1,offset:3,previous:new Uint8Array([3,4,5])},{op:2,offset:1,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,6])}];it("round trips",async()=>{let e=new P(await ut());await e.write(r),(0,Sr.expect)(await e.read()).to.deep.equal(r)})})});function $s(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function Js(r,e=0){e=Dr(149417,e);for(let t=0,s=r.length;t<s;t++)e=Dr(r[t],e);return e}function Dr(r,e){return(e<<5)-e+r|0}var kr,N,dt=m(()=>{kr=r=>typeof r=="function"?r():r,N=class{constructor(){this.table=new Map}set(e,t){let s=Js(e),i=this.table.get(s);if(!i){let n={buf:e,value:kr(t)};return this.table.set(s,[n]),n.value}for(let n of i)if($s(n.buf,e))return n.value;let o={buf:e,value:kr(t)};return i.push(o),o.value}*entries(){for(let e of this.table.values())for(let{buf:t,value:s}of e)yield[t,s]}*keys(){for(let e of this.table.values())for(let{buf:t}of e)yield t}*values(){for(let e of this.table.values())for(let{value:t}of e)yield t}}});var Ur,_r,Fr=m(()=>{q();dt();Ur=r=>{let e=0,t=new N,s=n=>({offset:t.set(n,()=>{let c=e;return e+=n.length,c}),len:n.length}),i=[];for(let n of r)n.op===0?i.push({...n,value:s(n.value)}):n.op===1?i.push({...n,previous:s(n.previous)}):i.push({...n,previous:s(n.previous),value:s(n.value)});let o=new Uint8Array(e);for(let[n,a]of t.entries())o.set(n,a);return{data:o,edits:i}},_r=({edits:r,data:e})=>{let t=({offset:s,len:i})=>e.slice(s,s+i);return r.map(s=>s.op===0?{...s,value:t(s.value)}:s.op===1?{...s,previous:t(s.previous)}:{...s,previous:t(s.previous),value:t(s.value)})}});var Vs={};var O,Cr=m(()=>{O=require("chai");q();Fr();pe();describe("HexDocumentModel",()=>{let r=[0,1,2,3,4,5,6,7,8,9],e;beforeEach(async()=>{e=new k({accessor:await fe(new Uint8Array(r)),supportsLengthChanges:!1,isFiniteSize:!0})}),describe("edit timeline",()=>{it("keeps offsets in replacements",()=>{e.makeEdits([{op:2,offset:6,value:new Uint8Array([16]),previous:new Uint8Array([6,7,8])},{op:2,offset:1,value:new Uint8Array([11]),previous:new Uint8Array([1,2,3])}]);let t=e.getEditTimeline();(0,O.expect)(t).to.deep.equal({sizeDelta:-4,ranges:[{op:0,editIndex:1,roffset:0,offset:0},{op:2,editIndex:1,offset:1,value:new Uint8Array([11])},{op:0,editIndex:1,roffset:4,offset:2},{op:2,editIndex:0,offset:4,value:new Uint8Array([16])},{op:0,editIndex:0,roffset:9,offset:5}]})})}),describe("serialization",()=>{it("round trips",()=>{let t=[{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:2,offset:2,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,3])},{op:1,offset:3,previous:new Uint8Array([3,4,5])}],s=Ur(t);(0,O.expect)(_r(s)).to.deep.equal(t),(0,O.expect)(s.data.length).to.equal(9)})}),describe("edit reading",()=>{let t=async s=>{for(let i=0;i<s.length;i++){let o=new Uint8Array;for await(let n of e.readWithEdits(i))o=Buffer.concat([o,n]);(0,O.expect)(o).to.deep.equal(Buffer.from(s.subarray(i)),`expected to be equal at offset ${i}`)}(0,O.expect)(await e.size()).to.equal(s.length)};it("reads file verbatim",async()=>{await t(new Uint8Array(r))}),it("reads with a simple insert",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])}]),await t(new Uint8Array([0,1,10,11,12,2,3,4,5,6,7,8,9]))}),it("reads with a simple delete",async()=>{e.makeEdits([{op:1,offset:2,previous:new Uint8Array([2,3,4])}]),await t(new Uint8Array([0,1,5,6,7,8,9]))}),it("reads with a simple replace",async()=>{e.makeEdits([{op:2,offset:2,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,3])}]),await t(new Uint8Array([0,1,10,11,12,5,6,7,8,9]))}),it("replaces at beginning",async()=>{e.makeEdits([{op:2,offset:0,value:new Uint8Array([10,11,12]),previous:new Uint8Array([0,1,2])}]),await t(new Uint8Array([10,11,12,3,4,5,6,7,8,9]))}),it("makes random replacements",async function(){this.timeout(1e4);let s=new Uint8Array(r),i=Rr("vs code!"),o=`- [${s.join(", ")}]
`,n=0;for(let a=0;a<1e3;a++){let c=Math.floor(i()*s.length),u=Math.floor((s.length-c)*i()),f=new Uint8Array(u),l=new Uint8Array(u);for(let y=0;y<u;y++)l[y]=s[c+y],f[y]=s[c+y]=n++&255;o+=`- arr.set(${c}, [${f.join(", ")}]) -> [${s.join(", ")}]
`,e.makeEdits([{op:2,offset:c,value:f,previous:l}]);try{await t(s)}catch(y){throw console.log(o),y}}}),it("works with multiple replacements",async()=>{e.makeEdits([{op:2,offset:6,value:new Uint8Array([16]),previous:new Uint8Array([6,7,8])},{op:2,offset:1,value:new Uint8Array([11]),previous:new Uint8Array([1,2,3])}]),await t(new Uint8Array([0,11,4,5,16,9]))}),it("overlaps replace on delete",async()=>{e.makeEdits([{op:1,offset:3,previous:new Uint8Array([3,4,5])},{op:2,offset:1,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,6])}]),await t(new Uint8Array([0,10,11,12,7,8,9]))}),it("overlaps replace on insert",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:2,offset:1,value:new Uint8Array([20,21,22]),previous:new Uint8Array([1,10,11])}]),await t(new Uint8Array([0,20,21,22,12,2,3,4,5,6,7,8,9]))}),it("delete overlaps multiple",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:1,offset:1,previous:new Uint8Array([1,10,11,12,2,3])}]),await t(new Uint8Array([0,4,5,6,7,8,9]))})})})});var Ys,ft,Ir=m(()=>{Ys=require("vscode"),ft=r=>typeof Buffer!="undefined"?Buffer.byteLength(r):new Blob([r]).size});var D,Tr,pt,x,ht=m(()=>{D=Symbol("Wildcard"),Tr=new Uint8Array(255);for(let r=0;r<255;r++)Tr[r]=r;pt=new Uint8Array(255);for(let r=0;r<255;r++)pt[r]=String.fromCharCode(r).toUpperCase().charCodeAt(0);x=class{constructor(e,t,s=Tr){this.needle=e;this.onMatch=t;this.equivalencyTable=s;this.needleLen=0;this.index=0;this.usableBuffer=0;for(let i of e)i===D?this.needleLen++:this.needleLen+=i.length;this.buffer=new Uint8Array(this.needleLen)}push(e){let{needleLen:t,buffer:s}=this;for(let i=0;i<e.length;i++)s[this.index++%t]=e[i],this.usableBuffer++,this.attemptMatch()}attemptMatch(){let{needle:e,needleLen:t,buffer:s,index:i,equivalencyTable:o}=this;if(this.usableBuffer<t)return;let n=0;for(let c=0;c<e.length;c++){let u=e[c];if(u===D){n++;continue}for(let f=0;f<u.length;f++){if(o[u[f]]!==o[s[(i+n)%t]])return;n++}}this.matchTmpBuf||(this.matchTmpBuf=new Uint8Array(t));let a=this.index%t;this.matchTmpBuf.set(s.subarray(a),0),this.matchTmpBuf.set(s.subarray(0,a),t-a),this.onMatch(this.index-t,this.matchTmpBuf),this.usableBuffer=0}}});var mt,he,me,Zs,ye,qr=m(()=>{Ir();ht();dt();mt=class{constructor(e,t){this.filesize=e;this.cap=t;this.buffers=new N;this.fileOffset=0;this.lastYieldedTime=Date.now();this.results=[]}get capped(){return this.cap===0}push(e,t,s){let i=this.buffers.set(e,()=>new Uint8Array(e));this.cap===void 0?this.results.push({from:t,to:s,previous:i}):this.cap>0&&(this.results.push({from:t,to:s,previous:i}),this.cap--)}toYield(){let e=Date.now();if(e-this.lastYieldedTime>mt.targetUpdateInterval){this.lastYieldedTime=e;let t=this.results;return this.results=[],{progress:this.filesize?this.fileOffset/this.filesize:0,results:t}}}final(){return{progress:1,capped:this.capped,results:this.results}}},he=mt;he.targetUpdateInterval=1e3;me=class{constructor(e,t,s,i){this.document=e;this.query=t;this.isCaseSensitive=s;this.cap=i;this.cancelled=!1}dispose(){this.cancelled=!0}async*search(){let{isCaseSensitive:e,query:t,document:s,cap:i}=this,o=new he(await s.size(),i),n=new x(t.literal.map(a=>a==="*"?D:a),(a,c)=>o.push(c,a,a+c.length),e?void 0:pt);for await(let a of s.readWithEdits(0)){if(this.cancelled||o.capped){yield o.final();return}n.push(a),o.fileOffset+=a.length;let c=o.toYield();c&&(yield c)}yield o.final()}},Zs=8*1024,ye=class{constructor(e,t,s,i){this.document=e;this.cap=i;this.cancelled=!1;this.re=new RegExp(t.re,s?"g":"ig")}dispose(){this.cancelled=!0}async*search(){let e="",t=0,{re:s,document:i}=this,o=new TextDecoder,n=new TextEncoder,a=new he(await i.size(),this.cap);for await(let c of i.readWithEdits(0)){if(this.cancelled||a.capped){yield a.final();return}e+=o.decode(c);let u=0;for(let y of e.matchAll(s)){let bt=t+ft(e.slice(0,y.index)),Wr=ft(y[0]);a.push(n.encode(y[0]),bt,bt+Wr),u=y.index+y[0].length}a.fileOffset+=c.length;let f=Math.max(e.length-Zs,u);f>0&&(t+=f,s.lastIndex=0,e=e.slice(f));let l=a.toYield();l&&(yield l)}yield a.final()}}});function Ks(r){for(;r.length;){let e=r.pop();e&&e.dispose()}}var yt,Pr=m(()=>{yt=class{constructor(){this._isDisposed=!1;this._disposables=[]}dispose(){this._isDisposed||(this._isDisposed=!0,Ks(this._disposables))}_register(e){return this._isDisposed?e.dispose():this._disposables.push(e),e}get isDisposed(){return this._isDisposed}}});var Or=m(()=>{});var vt,Mr=m(()=>{Or();vt=class{start(e,t){this._request?.dispose(),this._request=t,(async()=>{for await(let s of t.search())e.sendEvent({type:2,data:s})})()}cancel(){this._request?.dispose(),this._request=void 0}}});var g,F,Br=m(()=>{g=U(require("vscode"));q();rt();Pr();ot();Mr();F=class extends yt{constructor(e,t,s){super();this.model=e;this.isLargeFile=t;this.baseAddress=s;this.lastSave=0;this.searchProvider=new vt;this._onDidDispose=this._register(new g.EventEmitter);this.onDidDispose=this._onDidDispose.event;this._onDidRevert=this._register(new g.EventEmitter);this.onDidRevert=this._onDidRevert.event}static async create(e,{backupId:t,untitledDocumentData:s},i){let o=await j(e,s),n=new k({accessor:o,isFiniteSize:!0,supportsLengthChanges:!0,edits:t?{unsaved:await new P(g.Uri.parse(t)).read(),saved:[]}:void 0}),a=F.parseQuery(e.query),c=a.baseAddress?F.parseHexOrDecInt(a.baseAddress):0,u=await o.getSize();i.sendTelemetryEvent("fileOpen",{},{fileSize:u??0});let f=g.workspace.getConfiguration().get("hexeditor.maxFileSize")*1e6,l=!t&&!o.supportsIncremetalAccess&&(u??0)>f;return{document:new F(n,l,c),accessor:o}}get isReadonly(){return this.model.isReadonly}get uri(){return g.Uri.parse(this.model.uri)}readWithEdits(e){return this.model.readWithEdits(e)}async readBufferWithEdits(e,t){let s=new Uint8Array(t),i=0;for await(let o of this.model.readWithEdits(e)){let n=Math.min(o.length,s.length-i);if(s.set(o.subarray(0,n),i),i+=n,i===t)return s}return s.slice(0,i)}async readBuffer(e,t){let s=new Uint8Array(t),i=await this.model.readInto(e,s);return i===t?s:s.slice(0,i)}dispose(){this._onDidDispose.fire(),this.model.dispose(),super.dispose()}get isSynced(){return this.model.isSynced}get edits(){return this.model.edits}get unsavedEditIndex(){return this.model.unsavedEditIndex}makeEdits(e){return this.model.makeEdits(e)}insert(e,t){return this.model.makeEdits([{op:0,offset:e,value:t}])}async replace(e,t){let s=await this.readBufferWithEdits(e,t.length);return s.length===t.length?this.makeEdits([{op:2,offset:e,value:t,previous:s}]):this.makeEdits([{op:2,offset:e,value:t.subarray(0,s.length),previous:s},{op:0,offset:e+s.length,value:t.subarray(s.length)}])}size(){return this.model.size()}async save(e){this.lastSave=Date.now(),await this.model.save(),this.lastSave=Date.now()}async saveAs(e,t){if(t&&t.isCancellationRequested)return;if(!this.model.isFiniteSize)throw new Error("Cannot save a document without a finite size");let s=await j(e);this.lastSave=Date.now(),await s.writeStream(this.model.readWithEdits()),this.lastSave=Date.now(),this.model.dispose(),this.model=new k({accessor:s,isFiniteSize:!0,supportsLengthChanges:!0})}async revert(e){this.model.revert(),this._onDidRevert.fire()}async backup(e){return await new P(e).write(this.model.unsavedEdits),{id:e.toString(),delete:async()=>{try{await g.workspace.fs.delete(e)}catch{}}}}static parseQuery(e){let t={};if(e){let s=(e[0]==="?"?e.substr(1):e).split("&");for(let i of s){let o=i.split("="),n=o.shift();n&&(t[n]=o.join("="))}}return t}static parseHexOrDecInt(e){return e=e.toLowerCase(),e.startsWith("0x")?parseInt(e.substring(2),16):parseInt(e,10)}}});var Xs={};var Hr,Lr=m(()=>{qr();Hr=require("chai");Br();pe();q();describe("searchRequest",async()=>{let r=`Esse in aliqua minim magna dolor tempor eiusmod exercitation ullamco veniam nisi ipsum cillum commodo. Velit ad aliquip dolor sint anim consequat. Excepteur culpa non adipisicing elit tempor laborum tempor qui. Do esse dolore incididunt consequat non excepteur fugiat fugiat veniam deserunt ut pariatur eiusmod. Deserunt irure qui cupidatat laboris.

Irure nulla nulla consequat reprehenderit nisi nulla consequat dolor. Ad consectetur cillum consectetur ea. Reprehenderit esse in in anim mollit laboris eiusmod. Pariatur enim ipsum dolor eiusmod laboris mollit aliqua ullamco laborum fugiat non et. Officia adipisicing duis id sit aliqua et et occaecat. Commodo Lorem laborum aliquip officia ex quis elit elit do qui consectetur dolore.

Lorem ad ullamco ad deserunt voluptate ullamco et in commodo et exercitation duis nisi. Reprehenderit deserunt deserunt eiusmod velit mollit cillum pariatur Lorem exercitation laboris non. Ad eiusmod mollit reprehenderit amet ex elit deserunt cupidatat ullamco ullamco consectetur elit. Laboris duis cupidatat ipsum id anim occaecat pariatur.`,e=async(n,a)=>{let c;for await(let f of n.search())c=f.results.map(l=>({from:l.from,to:l.to,previous:l.previous}));if(!c)throw new Error("no result");let u=f=>f.sort((l,y)=>l.from-y.from).map(l=>({...l,previous:new TextDecoder().decode(l.previous)}));(0,Hr.expect)(u(c)).to.deep.equal(u(a))},t="laboris",s=new TextEncoder().encode(t),i=[{from:341,previous:s,to:348},{from:496,previous:s,to:503},{from:547,previous:s,to:554},{from:915,previous:s,to:922}],o=async(n=r)=>new F(new k({accessor:await fe(new TextEncoder().encode(n)),supportsLengthChanges:!1,isFiniteSize:!0}),!1,0);it("searches for literal",async()=>{let n=await o();await e(new me(n,{literal:[s]},!0,void 0),i)}),it("searches for literal case insensitive",async()=>{let n=await o();await e(new me(n,{literal:[s]},!1,void 0),[...i,{from:1026,previous:new TextEncoder().encode("Laboris"),to:1033}])}),it("searches for regex",async()=>{let n=await o();await e(new ye(n,{re:t},!0,void 0),i)}),it("searches for regex case insensitive",async()=>{let n=await o();await e(new ye(n,{re:t},!1,void 0),[...i,{from:1026,previous:new TextEncoder().encode("Laboris"),to:1033}])})})});var ei={};var M,zr=m(()=>{M=require("chai");ht();describe("literal search",()=>{let r=new TextEncoder().encode("Excepteur aliquip sit commodo eiusmod nulla ullamco amet reprehenderit incididunt labore ipsum pariatur non. Laborum labore deserunt incididunt mollit do ex ullamco labore quis occaecat amet. Elit amet laborum et ullamco est labore ea. Ipsum ex laborum officia sit Lorem sint enim fugiat in eu. Exercitation laborum est enim cupidatat irure reprehenderit ea duis elit aliquip anim. Sunt reprehenderit consequat consectetur velit proident cupidatat amet."),e=new TextEncoder().encode("laborum"),t=[{index:202,bytes:"laborum"},{index:245,bytes:"laborum"},{index:308,bytes:"laborum"}],s;beforeEach(()=>{s=[]});let i=(o,n)=>s.push({bytes:new TextDecoder().decode(n),index:o});it("is sane for simple strings",()=>{new x([e],i).push(r),(0,M.expect)(s).to.deep.equal(t)}),it("is sane for wildcards",()=>{new x([new TextEncoder().encode("lab"),D,new TextEncoder().encode("rum")],i).push(r),(0,M.expect)(s).to.deep.equal(t)}),it("is sane for leading wildcards",()=>{new x([D,new TextEncoder().encode("aborum")],i).push(r),(0,M.expect)(s).to.deep.equal([{index:109,bytes:"Laborum"},...t])}),it("works with random wildcards",()=>{for(let o=0;o<e.length;o++)for(let n=1;n<e.length-o;n++){let a=new Uint8Array(e.subarray(0,o)),c=new Array(n).fill(D),u=new Uint8Array(e.subarray(o+n));new x([a,...c,u],i).push(r);for(let l of t)(0,M.expect)(s).to.deep.contain(l);s=[]}}),it("works with random slicing",()=>{for(let o=1;o<100;o++){let n=new x([e],i);for(let a=0;a<r.length;a+=o)n.push(r.subarray(a,a+o));(0,M.expect)(s).to.deep.equal(t),s=[]}})})});var si={};Jr(si,{run:()=>ri});var G=U(require("mocha")),ti=[()=>Promise.resolve().then(()=>(Ar(),Qs)),()=>Promise.resolve().then(()=>(Cr(),Vs)),()=>Promise.resolve().then(()=>(Lr(),Xs)),()=>Promise.resolve().then(()=>(zr(),ei))];async function ri(){let r=new G.default({ui:"bdd",color:!0});for(let e of ti)r.suite.emit(G.default.Suite.constants.EVENT_FILE_PRE_REQUIRE,global,e,r),await e(),r.suite.emit(G.default.Suite.constants.EVENT_FILE_REQUIRE,{},e,r),r.suite.emit(G.default.Suite.constants.EVENT_FILE_POST_REQUIRE,global,e,r);return new Promise((e,t)=>{r.run(s=>{s>0?t(new Error(`${s} tests failed.`)):e()})})}module.exports=Vr(si);0&&(module.exports={run});
